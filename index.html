<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BoxTipping</title>
<style>
body {margin:0; font-family:sans-serif; background:#0b0b0b; color:#fff; overflow:hidden; display:flex; flex-direction:column; align-items:center;}
header {width:100%; text-align:center; padding:15px; background:rgba(0,0,0,0.5); font-size:24px; font-weight:bold; letter-spacing:2px;}
section {width:100%; height:100vh; display:none; flex-direction:column; align-items:center; justify-content:center; position:relative;}
canvas {border:2px solid #fff; background:#111; touch-action:none; border-radius:10px; margin-top:10px;}
#info {position:absolute; top:20px; left:10px; font-size:18px; background:rgba(0,0,0,0.3); padding:5px 10px; border-radius:5px;}
#powerups {position:absolute; top:20px; right:10px; display:flex; gap:5px;}
.powerup {width:30px; height:30px; background:lime; border-radius:50%; display:flex; justify-content:center; align-items:center; font-size:18px;}
#weapons {position:absolute; bottom:80px; right:10px; display:flex; gap:5px;}
.weaponBtn {padding:10px; border:none; border-radius:5px; font-weight:bold; cursor:pointer;}
#laserBtn {background:red; color:#fff;}
#bombBtn {background:orange; color:#000;}
#freezeBtn {background:cyan; color:#000;}
button {padding:12px 25px; font-size:16px; border:none; border-radius:5px; cursor:pointer; margin:5px;}
#toMainPage {background:blue; color:#fff; position:absolute; bottom:20px; left:50%; transform:translateX(-50%);}
#payMainPage {background:gold; color:#000; margin-top:20px;}
</style>
</head>
<body>

<header>BoxTipping</header>

<!-- --- GAME SECTION --- -->
<section id="gameSection" style="display:flex;">
<div id="info">Score: 0 | Level: 1 | Time: 60</div>
<div id="powerups"></div>
<canvas id="gameCanvas" width="360" height="640"></canvas>
<div id="weapons">
    <button id="laserBtn" class="weaponBtn">Laser</button>
    <button id="bombBtn" class="weaponBtn">Bomb</button>
    <button id="freezeBtn" class="weaponBtn">Freeze</button>
</div>
<button id="toMainPage">Main Page</button>
</section>

<!-- --- MAIN PAGE SECTION --- -->
<section id="mainSection">
<h1>Main Page</h1>
<button id="payMainPage">Zutritt für 0,0002 ETH</button>
<div id="accessStatus" style="margin-top:15px; font-size:18px; color:lime;"></div>
<button id="backToGame">Back to Game</button>
</section>

<script src="https://cdn.jsdelivr.net/npm/ethers@6/dist/ethers.umd.min.js"></script>
<script>
// ------------------- PAGE SWITCH -------------------
const gameSection = document.getElementById('gameSection');
const mainSection = document.getElementById('mainSection');
document.getElementById('toMainPage').addEventListener('click', ()=>{
    gameSection.style.display='none';
    mainSection.style.display='flex';
});
document.getElementById('backToGame').addEventListener('click', ()=>{
    mainSection.style.display='none';
    gameSection.style.display='flex';
});

// ------------------- GAME SETUP -------------------
const canvas=document.getElementById('gameCanvas');
const ctx=canvas.getContext('2d');
const info=document.getElementById('info');
const powerupDiv=document.getElementById('powerups');

let score=0, level=1, timeLeft=60, gameOver=false, unlocked=false;
let activePowerups={}, weaponCooldowns={laser:0,bomb:0,freeze:0};
const weaponCooldownTime={laser:1000,bomb:5000,freeze:3000};

class Box{constructor(){this.size=50;this.x=Math.random()*(canvas.width-50);this.y=Math.random()*(canvas.height-50);this.color='red';} draw(){ctx.fillStyle=this.color;ctx.fillRect(this.x,this.y,this.size,this.size);} respawn(){this.x=Math.random()*(canvas.width-this.size);this.y=Math.random()*(canvas.height-this.size); spawnPowerup();}}
class Enemy{constructor(){this.size=40;this.x=Math.random()*(canvas.width-40);this.y=-this.size;this.speed=2+Math.random()*level; this.frozen=false;} draw(){ctx.fillStyle='orange'; ctx.fillRect(this.x,this.y,this.size,this.size);} update(){if(!this.frozen){let speed=activePowerups.speedBoost?1:this.speed||2; this.y+=speed; if(this.y>canvas.height){ this.y=-this.size; this.x=Math.random()*(canvas.width-this.size);}}}}

let playerBox=new Box();
let enemies=[];
function spawnEnemies(){ enemies=[]; for(let i=0;i<level+2;i++) enemies.push(new Enemy()); }
spawnEnemies();

const powerupTypes=['speedBoost','scoreX2','extraTime'];
function spawnPowerup(){ if(Math.random()<0.2){const type=powerupTypes[Math.floor(Math.random()*powerupTypes.length)]; activePowerups[type]=type==='extraTime'?true:Date.now()+10000; if(type==='extraTime') timeLeft+=10; renderPowerups();}}
function renderPowerups(){ powerupDiv.innerHTML=''; for(let p in activePowerups){ const div=document.createElement('div'); div.className='powerup'; div.textContent=p==='speedBoost'?'S':p==='scoreX2'?'x2':'T'; powerupDiv.appendChild(div);}}

canvas.addEventListener('touchstart',e=>{
    if(gameOver) return;
    const rect=canvas.getBoundingClientRect();
    const touch=e.touches[0];
    const x=touch.clientX-rect.left;
    const y=touch.clientY-rect.top;
    if(x>=playerBox.x && x<=playerBox.x+playerBox.size && y>=playerBox.y && y<=playerBox.y+playerBox.size){
        let points=activePowerups.scoreX2?2:1;
        score+=points;
        playerBox.respawn();
        if(score%5===0){ level++; spawnEnemies(); }
    }
});

const timer=setInterval(()=>{ if(gameOver) return; timeLeft--; if(timeLeft<=0){ gameOver=true; alert(`Game Over! Score: ${score}`); clearInterval(timer); } },1000);

// --- Waffen ---
function useWeapon(type){ const now=Date.now(); if(now<weaponCooldowns[type]) return; weaponCooldowns[type]=now+weaponCooldownTime[type];
    if(type==='laser'){ enemies.forEach(e=>{ if(e.x+e.size/2>playerBox.x && e.x+e.size/2<playerBox.x+playerBox.size){ e.y=-e.size; score++; }});}
    else if(type==='bomb'){ enemies.forEach(e=>{ const dx=(playerBox.x+playerBox.size/2)-(e.x+e.size/2); const dy=(playerBox.y+playerBox.size/2)-(e.y+e.size/2); const dist=Math.sqrt(dx*dx+dy*dy); if(dist<100){ e.y=-e.size; score++; }});}
    else if(type==='freeze'){ enemies.forEach(e=>{ e.frozen=true; }); setTimeout(()=>{ enemies.forEach(e=>{ e.frozen=false; }); },3000);}
}
document.getElementById('laserBtn').addEventListener('click',()=>useWeapon('laser'));
document.getElementById('bombBtn').addEventListener('click',()=>useWeapon('bomb'));
document.getElementById('freezeBtn').addEventListener('click',()=>useWeapon('freeze'));

function gameLoop(){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    for(let i=0;i<50;i++){ ctx.fillStyle='rgba(255,255,255,0.05)'; ctx.fillRect(Math.random()*canvas.width,Math.random()*canvas.height,2,2); }
    playerBox.draw();
    enemies.forEach(e=>{ e.update(); e.draw(); });
    const now=Date.now();
    for(let p in activePowerups){ if(activePowerups[p]!==true && now>activePowerups[p]) delete activePowerups[p]; }
    renderPowerups();
    info.textContent=`Score: ${score} | Level: ${level} | Time: ${timeLeft}`;
    if(!gameOver) requestAnimationFrame(gameLoop);
}
gameLoop();

// ------------------- MAIN PAGE PAYMENT -------------------
const payMainPageBtn=document.getElementById('payMainPage');
const accessStatus=document.getElementById('accessStatus');
payMainPageBtn.addEventListener('click', async ()=>{
    if(!window.ethereum){ alert('Wallet nicht gefunden!'); return; }
    try{
        await window.ethereum.request({ method:'eth_requestAccounts' });
        const provider = new ethers.BrowserProvider(window.ethereum);
        const signer = await provider.getSigner();
        const tx = await signer.sendTransaction({
            to: '@thesafe',
            value: ethers.parseEther("0.0002")
        });
        await tx.wait();
        accessStatus.textContent="Zutritt gewährt!";
        accessStatus.style.color="lime";
    }catch(e){ console.error(e); accessStatus.textContent="Payment fehlgeschlagen!"; accessStatus.style.color="red"; }
});
</script>

</body>
</html>

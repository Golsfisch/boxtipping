<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BoxTipping + Main Page</title>
<style>
body {margin:0; font-family:sans-serif; background:#0b0b0b; color:#fff; overflow:hidden;}
header {width:100%; text-align:center; padding:15px; background:rgba(0,0,0,0.5); font-size:24px; font-weight:bold; letter-spacing:2px;}
section {width:100%; height:100vh; display:none; flex-direction:column; align-items:center; justify-content:center; position:relative;}
canvas {border:2px solid #fff; background:#111; touch-action:none; border-radius:10px;}
#info {position:absolute; top:20px; left:10px; font-size:18px; background:rgba(0,0,0,0.3); padding:5px 10px; border-radius:5px;}
#powerups {position:absolute; top:20px; right:10px; display:flex; gap:5px;}
.powerup {width:30px; height:30px; background:lime; border-radius:50%; display:flex; justify-content:center; align-items:center; font-size:18px;}
#weapons {position:absolute; bottom:20px; right:10px; display:flex; gap:5px;}
.weaponBtn {padding:10px; border:none; border-radius:5px; font-weight:bold; cursor:pointer;}
#laserBtn {background:red; color:#fff;}
#bombBtn {background:orange; color:#000;}
#freezeBtn {background:cyan; color:#000;}
button {padding:12px 25px; font-size:16px; border:none; border-radius:5px; cursor:pointer; margin:5px;}
#payButton {display:none; background:gold; color:#000; box-shadow:0 4px 8px rgba(0,0,0,0.3);}
#toMainPage {background:blue; color:#fff;}
#ethBalance, #fiatBalance {font-size:20px; margin:10px;}
footer {position:absolute; bottom:10px; font-size:14px; color:#ccc; text-align:center; width:100%;}
</style>
</head>
<body>

<header>BoxTipping + Main Page</header>

<!-- --- SECTION 1: GAME --- -->
<section id="gameSection" style="display:flex;">
<div id="info">Score: 0 | Level: 1 | Time: 60</div>
<div id="powerups"></div>
<button id="payButton">Unlock Level 4 (Pay 0.001 ETH)</button>
<canvas id="gameCanvas" width="360" height="640"></canvas>
<div id="weapons">
    <button id="laserBtn" class="weaponBtn">Laser</button>
    <button id="bombBtn" class="weaponBtn">Bomb</button>
    <button id="freezeBtn" class="weaponBtn">Freeze</button>
</div>
<button id="toMainPage">Main Page</button>
<footer>Tippe die roten Boxen! Power-Ups & Waffen helfen dir! Ab Level 4 Krypto-Payment nötig.</footer>
</section>

<!-- --- SECTION 2: MAIN PAGE --- -->
<section id="mainSection">
<h1>Main Page</h1>
<div id="ethBalance">ETH: 0</div>
<div id="fiatBalance">Fiat: 0 €</div>
<button id="sendETH">Send 0.001 ETH</button>
<button id="addFiat">Add 10 €</button>
<button id="backToGame">Back to Game</button>
</section>

<script src="https://cdn.jsdelivr.net/npm/ethers@6/dist/ethers.umd.min.js"></script>
<script>
// ------------------- PAGE SWITCH -------------------
const gameSection = document.getElementById('gameSection');
const mainSection = document.getElementById('mainSection');
document.getElementById('toMainPage').addEventListener('click', ()=>{
    gameSection.style.display='none';
    mainSection.style.display='flex';
    updateEthBalance();
});
document.getElementById('backToGame').addEventListener('click', ()=>{
    mainSection.style.display='none';
    gameSection.style.display='flex';
});

// ------------------- GAME SETUP -------------------
const canvas=document.getElementById('gameCanvas');
const ctx=canvas.getContext('2d');
const info=document.getElementById('info');
const payButton=document.getElementById('payButton');
const powerupDiv=document.getElementById('powerups');

let score=0, level=1, timeLeft=60, gameOver=false, unlocked=false;
let activePowerups={}, weaponCooldowns={laser:0,bomb:0,freeze:0};
const weaponCooldownTime={laser:1000,bomb:5000,freeze:8000};

class Box{constructor(){this.size=50;this.x=Math.random()*(canvas.width-50);this.y=Math.random()*(canvas.height-50);this.color='red';} draw(){ctx.fillStyle=this.color;ctx.fillRect(this.x,this.y,this.size,this.size);} respawn(){this.x=Math.random()*(canvas.width-this.size);this.y=Math.random()*(canvas.height-this.size); spawnPowerup();}}
class Enemy{constructor(){this.size=40;this.x=Math.random()*(canvas.width-40);this.y=-this.size;this.speed=2+Math.random()*level;this.color='orange'; this.frozen=false;} draw(){ctx.fillStyle=this.color;ctx.fillRect(this.x,this.y,this.size,this.size);} update(){if(!this.frozen){let speedFactor=activePowerups.speedBoost?0.5:1; this.y+=this.speed*speedFactor; if(this.y>canvas.height){ this.y=-this.size; this.x=Math.random()*(canvas.width-this.size);}}}}

let playerBox=new Box();
let enemies=[];
function spawnEnemies(){ enemies=[]; for(let i=0;i<level+2;i++) enemies.push(new Enemy()); }
spawnEnemies();

const powerupTypes=['speedBoost','scoreX2','extraTime'];
function spawnPowerup(){ if(Math.random()<0.2){const type=powerupTypes[Math.floor(Math.random()*powerupTypes.length)]; activePowerups[type]=type==='extraTime'?true:Date.now()+10000; if(type==='extraTime') timeLeft+=10; renderPowerups();}}
function renderPowerups(){ powerupDiv.innerHTML=''; for(let p in activePowerups){ const div=document.createElement('div'); div.className='powerup'; div.textContent=p==='speedBoost'?'S':p==='scoreX2'?'x2':'T'; powerupDiv.appendChild(div);}}

canvas.addEventListener('touchstart',e=>{
    if(gameOver) return;
    const rect=canvas.getBoundingClientRect();
    const touch=e.touches[0];
    const x=touch.clientX-rect.left;
    const y=touch.clientY-rect.top;
    if(x>=playerBox.x && x<=playerBox.x+playerBox.size && y>=playerBox.y && y<=playerBox.y+playerBox.size){
        let points=activePowerups.scoreX2?2:1;
        score+=points;
        playerBox.respawn();
        if(score%5===0){ level++; if(level>3 && !unlocked){ payButton.style.display='block'; return; } spawnEnemies();}
    }
});

const timer=setInterval(()=>{ if(gameOver) return; timeLeft--; if(timeLeft<=0){ gameOver=true; alert(`Game Over! Dein Score: ${score}`); clearInterval(timer); } },1000);

async function payForLevel(){ 
    if(!window.ethereum){ alert('Wallet nicht gefunden!'); return; } 
    try{ 
        await window.ethereum.request({ method:'eth_requestAccounts' }); 
        const provider=new ethers.BrowserProvider(window.ethereum); 
        const signer=await provider.getSigner(); 
        const tx=await signer.sendTransaction({ to:'0xDeineAdresseHier', value:ethers.parseEther("0.001") }); 
        await tx.wait(); 
        unlocked=true; 
        payButton.style.display='none'; 
        alert('Level 4 freigeschaltet!'); 
        spawnEnemies();
    }catch(e){ console.error(e); alert('Payment fehlgeschlagen.');}
}
payButton.addEventListener('click',payForLevel);

function useWeapon(type){ const now=Date.now(); if(now<weaponCooldowns[type]) return; weaponCooldowns[type]=now+weaponCooldownTime[type];
    if(type==='laser'){ enemies.forEach(e=>{ if(e.x+e.size/2>playerBox.x && e.x+e.size/2<playerBox.x+playerBox.size){ e.y=-e.size; score++; }});}
    else if(type==='bomb'){ enemies.forEach(e=>{ const dx=(playerBox.x+playerBox.size/2)-(e.x+e.size/2); const dy=(playerBox.y+playerBox.size/2)-(e.y+e.size/2); const dist=Math.sqrt(dx*dx+dy*dy); if(dist<100){ e.y=-e.size; score++; }});}
    else if(type==='freeze'){ enemies.forEach(e=>{ e.frozen=true; }); setTimeout(()=>{ enemies.forEach(e=>{ e.frozen=false; }); },3000);}
}
document.getElementById('laserBtn').addEventListener('click',()=>useWeapon('laser'));
document.getElementById('bombBtn').addEventListener('click',()=>useWeapon('bomb'));
document.getElementById('freezeBtn').addEventListener('click',()=>useWeapon('freeze'));

function gameLoop(){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    for(let i=0;i<50;i++){ ctx.fillStyle='rgba(255,255,255,0.05)'; ctx.fillRect(Math.random()*canvas.width,Math.random()*canvas.height,2,2); }
    playerBox.draw();
    enemies.forEach(e=>{ e.update(); e.draw(); if(playerBox.x<e.x+e.size && playerBox.x+playerBox.size>e.x && playerBox.y<e.y+e.size && playerBox.y+playerBox.size>e.y){ score=Math.max(0,score-1); e.y=-e.size; }});
    const now=Date.now();
    for(let p in activePowerups){ if(activePowerups[p]!==true && now>activePowerups[p]) delete activePowerups[p]; }
    renderPowerups();
    info.textContent=`Score: ${score} | Level: ${level} | Time: ${timeLeft}`;
    if(!gameOver && (level<=3 || unlocked)) requestAnimationFrame(gameLoop);
}
gameLoop();

// ------------------- MAIN PAGE -------------------
const ethBalanceDiv = document.getElementById('ethBalance');
const fiatBalanceDiv = document.getElementById('fiatBalance');
let fiatBalance = 0;

async function updateEthBalance(){
    if(!window.ethereum){ alert('Wallet nicht gefunden!'); return; }
    const provider = new ethers.BrowserProvider(window.ethereum);
    const accounts = await provider.listAccounts();
    if(accounts.length===0){ await window.ethereum.request({ method:'eth_requestAccounts' }); }
    const balance = await provider.getBalance(accounts[0]);
    ethBalanceDiv.textContent = 'ETH: '+ethers.formatEther(balance);
}
document.getElementById('sendETH').addEventListener('click', async ()=>{
    const provider = new ethers.BrowserProvider(window.ethereum);
    const signer = await provider.getSigner();
    const tx = await signer.sendTransaction({ to: '0xDeineAdresseHier', value: ethers.parseEther("0.001") });
    await tx.wait();
    alert('ETH gesendet!');
    updateEthBalance();
});
document.getElementById('addFiat').addEventListener('click', ()=>{
    fiatBalance+=10;
    fiatBalanceDiv.textContent='Fiat: '+fiatBalance+' €';
});
</script>
</body>
</html>

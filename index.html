<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8" />
<title>BoxTipping Ultimate — AutoReset + SOL Pay</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
  :root{--bg:#111;--panel:#222;--accent:#4caf50;--muted:#888}
  html,body{height:100%;margin:0;background:var(--bg);font-family:Inter,Arial,sans-serif;color:#fff;user-select:none}
  canvas{display:block;margin:14px auto;border:2px solid #444;background:var(--panel)}
  #ui{position:fixed;left:12px;top:8px;z-index:40}
  #menu{background:#333;border:0;color:#fff;padding:6px 10px;border-radius:6px;cursor:pointer}
  #status{position:fixed;right:12px;top:8px;background:#222;padding:6px 10px;border-radius:6px;border:1px solid #444}
  .overlay{
    position:fixed;left:0;top:0;width:100%;height:100%;display:flex;align-items:center;justify-content:center;
    background:rgba(0,0,0,0.75);z-index:50;backdrop-filter:blur(2px)
  }
  .card{background:#141414;border:1px solid #333;padding:22px;border-radius:10px;text-align:center;max-width:420px}
  .btn{background:var(--accent);border:0;color:#fff;padding:10px 16px;border-radius:8px;cursor:pointer;font-weight:600}
  .btn.ghost{background:transparent;border:1px solid #666;color:#fff}
  .small{font-size:13px;color:var(--muted);margin-top:8px}
  #playBtn{width:86px;height:86px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:28px}
  #hud{position:fixed;left:50%;transform:translateX(-50%);top:8px;z-index:30;display:flex;gap:12px;align-items:center}
  .hudItem{background:rgba(0,0,0,0.25);padding:6px 10px;border-radius:8px;border:1px solid #333}
</style>
</head>
<body>

<div id="ui">
  <button id="menu" aria-label="Menü">Menü</button>
</div>

<div id="hud">
  <div class="hudItem" id="score">Score: 0</div>
  <div class="hudItem" id="level">Level: 1</div>
  <div class="hudItem" id="hits">Hits: 0 / 8</div>
</div>

<canvas id="game" width="420" height="680"></canvas>

<!-- Play overlay after Auto-Reset to Level 1 -->
<div id="pausedOverlay" class="overlay" style="display:none">
  <div class="card">
    <div style="font-size:20px;margin-bottom:10px">Auto-Reset: Level 1</div>
    <div style="margin-bottom:12px;color:var(--muted)">Du wurdest 8× getroffen — das Spiel wurde auf Level 1 zurückgesetzt und pausiert.</div>
    <button id="playBtn" class="btn" title="Weiterspielen">▶️</button>
    <div class="small">Klicke ▶️ um weiterzuspielen</div>
  </div>
</div>

<!-- Pay overlay for SOL payment (simulated) -->
<div id="payOverlay" class="overlay" style="display:none">
  <div class="card">
    <div style="font-size:20px;margin-bottom:8px">SOL Payment erforderlich</div>
    <div style="margin-bottom:14px;color:var(--muted)">Du hast weitere 8 Treffer erreicht. Zahle 50 Cent (in SOL) um weiterzuspielen.</div>
    <button id="payBtn" class="btn">Zahle 50¢ (SOL)</button>
    <div style="margin-top:10px">
      <button id="cancelBlock" class="btn ghost" style="margin-right:8px">Abbrechen (Blockiert)</button>
    </div>
    <div class="small">Bezahlung ist simuliert — Klick setzt Freigabe</div>
  </div>
</div>

<!-- optional menu content (kept minimal) -->
<div id="menuContent" style="display:none;position:fixed;left:12px;top:44px;background:#141414;padding:10px;border-radius:8px;border:1px solid #2a2a2a;z-index:60">
  <a href="seite2.html" style="color:#fff;text-decoration:none">BoxTipping V2</a>
</div>

<script>
/*
  BoxTipping Ultimate (adapted)
  - No restart button
  - 8 hits -> Auto-reset to Level 1 and PAUSE (play overlay)
  - After resume, next 8 hits -> SOL pay overlay (simulated). Block until pay.
  - Free movement (x/y) when level >= 4
  - No bosses
*/

// Canvas + ctx
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');

// HUD elements
const scoreEl = document.getElementById('score');
const levelEl = document.getElementById('level');
const hitsEl = document.getElementById('hits');

const pausedOverlay = document.getElementById('pausedOverlay');
const playBtn = document.getElementById('playBtn');
const payOverlay = document.getElementById('payOverlay');
const payBtn = document.getElementById('payBtn');
const cancelBlock = document.getElementById('cancelBlock');

const menuBtn = document.getElementById('menu');
const menuContent = document.getElementById('menuContent');
menuBtn.addEventListener('click', ()=> menuContent.style.display = menuContent.style.display === 'none' ? 'block' : 'none');

// Game state
let score = 0;
let level = 1;
let hits = 0;
const MAX_HITS = 8;

let gameRunning = true;
let payUnlocked = false;     // becomes true after simulated payment
let firstPhaseResetDone = false; // tracks whether initial auto-reset already happened

// Entities
let enemies = [];
let bullets = [];
let powerups = [];
let weapons = [];

// Player
const player = {
  x: canvas.width/2 - 20,
  y: canvas.height - 80,
  w: 40,
  h: 40,
  speed: 6
};

// Input
const keys = {};
window.addEventListener('keydown', e => keys[e.key] = true);
window.addEventListener('keyup', e => keys[e.key] = false);

// Utility spawners
function spawnEnemy(){
  enemies.push({
    x: Math.random()*(canvas.width-36),
    y: -34,
    w: 34,
    h: 34,
    speed: 1.6 + Math.random()*level*0.4
  });
}

function spawnPowerup(){
  powerups.push({
    x: Math.random()*(canvas.width-20),
    y: -20,
    w: 18,
    h: 18,
    type: Math.random() < 0.6 ? 'gun' : 'freeze',
    speed: 1.8
  });
}

// Shooting
function shootBullet(){
  bullets.push({
    x: player.x + player.w/2 - 4,
    y: player.y,
    w: 8,
    h: 12,
    speed: 8
  });
}

// Phase: auto-reset to level1 and pause
function doAutoResetAndPause(){
  // Reset to Level 1 (as requested). Keep score (we keep score but you can set score=0 if desired)
  level = 1;
  // Clear entities
  enemies = [];
  bullets = [];
  powerups = [];
  weapons = [];
  // Reset player position
  player.x = canvas.width/2 - player.w/2;
  player.y = canvas.height - 80;
  // mark first reset happened
  firstPhaseResetDone = true;
  // Reset hits count for the next phase but we pause first
  hits = 0;
  // Pause game and show big Play icon
  gameRunning = false;
  pausedOverlay.style.display = 'flex';
  updateHUD();
}

// When paywall triggered: block until payUnlocked
function triggerPaywall(){
  gameRunning = false;
  payOverlay.style.display = 'flex';
  updateHUD();
}

// HUD update
function updateHUD(){
  scoreEl.textContent = 'Score: ' + score;
  levelEl.textContent = 'Level: ' + level;
  hitsEl.textContent = 'Hits: ' + hits + ' / ' + MAX_HITS;
}

// Main loop: always renders, only updates movement/spawn when gameRunning==true
let frameCounter = 0;
function loop(){
  requestAnimationFrame(loop);

  // always draw background and UI so overlays sit on top
  // background
  ctx.fillStyle = '#0f0f0f';
  ctx.fillRect(0,0,canvas.width,canvas.height);

  // subtle animated background stars (not heavy)
  for(let i=0;i<30;i++){
    ctx.fillStyle = 'rgba(255,255,255,0.03)';
    ctx.fillRect((frameCounter*3 + i*67) % canvas.width, (i*47 + frameCounter) % canvas.height, 2,2);
  }

  // If game running -> update positions & collisions
  if(gameRunning){
    frameCounter++;

    // spawn logic (difficulty scales with level)
    if(enemies.length < 3 + level) spawnEnemy();
    if(Math.random() < 0.012) spawnPowerup();

    // update enemies
    for(let i=enemies.length-1;i>=0;i--){
      let e = enemies[i];
      e.y += e.speed;
      // collision with player
      if(e.y + e.h >= player.y && e.x < player.x + player.w && e.x + e.w > player.x){
        enemies.splice(i,1);
        hits++;
        // check hit rules
        if(!firstPhaseResetDone && hits >= MAX_HITS){
          // first 8 hits -> auto reset to level1 + pause
          doAutoResetAndPause();
        } else if(firstPhaseResetDone && !payUnlocked && hits >= MAX_HITS){
          // after resume, getting 8 hits triggers paywall
          triggerPaywall();
        } else if(firstPhaseResetDone && payUnlocked && hits >= MAX_HITS){
          // if already paid, auto-reset phase (clear, continue)
          hits = 0;
          enemies = []; bullets = []; powerups = []; weapons = [];
          player.x = canvas.width/2 - player.w/2;
          player.y = canvas.height - 80;
        }
      } else if(e.y > canvas.height + 20){
        enemies.splice(i,1);
      }
    }

    // update bullets
    for(let i=bullets.length-1;i>=0;i--){
      let b = bullets[i];
      b.y -= b.speed;
      if(b.y < -20){
        bullets.splice(i,1);
        continue;
      }
      // bullet hits enemy
      for(let j=enemies.length-1;j>=0;j--){
        let e = enemies[j];
        if(b.x < e.x + e.w && b.x + b.w > e.x && b.y < e.y + e.h && b.y + b.h > e.y){
          bullets.splice(i,1);
          enemies.splice(j,1);
          score += 10;
          break;
        }
      }
    }

    // update powerups
    for(let i=powerups.length-1;i>=0;i--){
      let p = powerups[i];
      p.y += p.speed;
      if(p.y > canvas.height + 20){ powerups.splice(i,1); continue; }
      // pickup
      if(player.x < p.x + p.w && player.x + player.w > p.x && player.y < p.y + p.h && player.y + player.h > p.y){
        powerups.splice(i,1);
        if(p.type === 'gun') weapons.push({duration: 180}); // example
      }
    }

    // weapons duration decrement
    for(let i=weapons.length-1;i>=0;i--){
      weapons[i].duration--;
      if(weapons[i].duration <= 0) weapons.splice(i,1);
    }

    // movement input
    let mv = player.speed;
    // movement behavior:
    // level < 4 => only left/right; level >=4 => free movement (x/y)
    if(level < 4){
      if(keys['ArrowLeft'] || keys['a'] || keys['A']) player.x -= mv;
      if(keys['ArrowRight'] || keys['d'] || keys['D']) player.x += mv;
    } else {
      if(keys['ArrowLeft'] || keys['a'] || keys['A']) player.x -= mv;
      if(keys['ArrowRight'] || keys['d'] || keys['D']) player.x += mv;
      if(keys['ArrowUp'] || keys['w'] || keys['W']) player.y -= mv;
      if(keys['ArrowDown'] || keys['s'] || keys['S']) player.y += mv;
    }
    // clamp
    if(player.x < 0) player.x = 0;
    if(player.x + player.w > canvas.width) player.x = canvas.width - player.w;
    if(player.y < 0) player.y = 0;
    if(player.y + player.h > canvas.height) player.y = canvas.height - player.h;

    // shoot (space)
    if(keys[' ']) {
      // simple rate limit: allow bullet every ~10 frames
      if(frameCounter % 8 === 0) shootBullet();
    }
  } // end if gameRunning

  // DRAW ENTITIES (render even when paused to show scene)
  // player
  ctx.fillStyle = '#e44';
  ctx.fillRect(player.x, player.y, player.w, player.h);

  // bullets
  ctx.fillStyle = '#2ee';
  bullets.forEach(b => ctx.fillRect(b.x, b.y, b.w, b.h));

  // enemies
  ctx.fillStyle = '#ffcc33';
  enemies.forEach(e => ctx.fillRect(e.x, e.y, e.w, e.h));

  // powerups
  powerups.forEach(p => {
    ctx.fillStyle = p.type === 'gun' ? '#3b82f6' : '#10b981';
    ctx.fillRect(p.x, p.y, p.w, p.h);
  });

  // simple footer hint
  ctx.fillStyle = '#aaa';
  ctx.font = '12px Arial';
  ctx.fillText('Use Arrow keys or WASD. Space to shoot.', 10, canvas.height - 8);

  // update HUD every frame
  updateHUD();
}

// PLAY (resume) button click
playBtn.addEventListener('click', () => {
  pausedOverlay.style.display = 'none';
  // after first auto-reset, allow play to continue with hits=0 and firstPhaseResetDone true
  gameRunning = true;
  hits = 0;
  // level already set to 1 in doAutoResetAndPause
});

// PAY button click (simulate SOL payment)
payBtn.addEventListener('click', () => {
  // simulate successful payment
  payUnlocked = true;
  payOverlay.style.display = 'none';
  hits = 0;
  gameRunning = true;
});

// cancel block (just keep blocked — shows how to keep blocked)
cancelBlock.addEventListener('click', () => {
  // keep game blocked (overlay visible) — do nothing
  // but set a small notice or sound in a real build
  alert('Spiel bleibt blockiert bis zur Zahlung.');
});

// shooting by mouse click (optional)
canvas.addEventListener('click', (ev) => {
  // if paused due to auto-reset or payOverlay visible, clicks shouldn't shoot
  if(!gameRunning) return;
  shootBullet();
});

// Start the loop
loop();

</script>
</body>
</html>
